<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI VS HUMAN</title>
  <style>
    body {
      margin: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #fff;
      color: #000;
      font-family: sans-serif;
      min-height: 100vh;
    }
    h1 {
      margin: 6px 0 14px;
      font-weight: 700;
      font-size: 1.4rem;
    }
    #controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 680px;
      margin-bottom: 14px;
    }
    select, button {
      cursor: pointer;
      font-size: 0.8rem;
      padding: 7px 14px;
      border: none;
      border-radius: 7px;
      background: #0d6efd;
      color: #fff;
      font-weight: 600;
      min-width: 110px;
    }
    select:hover, button:hover:not(:disabled) { background: #084cdf; }
    button:disabled { background: #7ea9e5; cursor: default; }
    #board {
      border: 3px solid #444;
      width: 600px;
      height: 600px;
      max-width: 95vw;
      background: #fafafa;
      border-radius: 12px;
    }
    #log {
      margin-top: 14px;
      max-width: 680px;
      width: 95vw;
      height: 110px;
      background: #f0f0f0;
      border-radius: 12px;
      border: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
      font-size: 0.75rem;
      white-space: pre-wrap;
    }
    @media(max-width:600px) {
      button, select { font-size: 0.7rem; padding: 6px 10px; min-width: 70px; }
      h1 { font-size: 1.2rem; }
      #board { width: 95vw; height: 95vw; }
      #log { height: 90px; }
    }
  </style>
</head>
<body>
  <h1>ğŸ‘¾ AI VS HUMAN ğŸ‘¾</h1>
  <div id="controls">
    <select id="firstTurn">
      <option value="1">í”Œë ˆì´ì–´ ì„ ê³µ</option>
      <option value="2">AI ì„ ê³µ</option>
    </select>
    <select id="difficulty">
      <option value="1">ì‰¬ì›€</option>
      <option value="2">ë³´í†µ</option>
      <option value="3" selected>ì–´ë ¤ì›€</option>
      <option value="4">ë§¤ìš° ì–´ë ¤ì›€</option>
      <option value="5">ê³ ìˆ˜</option>
      <option value="6">ì‹ ì˜ í•œ ìˆ˜</option>
    </select>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
    <button id="undoBtn" disabled>ë¬´ë¥´ê¸°</button>
    <button id="restartBtn" disabled>ë‹¤ì‹œ ì‹œì‘</button>
    <button id="forfeitBtn" disabled>í¬ê¸°í•˜ê¸°</button>
  </div>
  <canvas id="board" width="600" height="600"></canvas>
  <div id="log"></div>
  <script>

(() => {
  const $ = id => document.getElementById(id), c = $("board"), ctx = c.getContext("2d"), log = $("log");
  const size = 15, bSize = 540, offset = (c.width - bSize) / 2, cell = bSize / (size - 1);
  let board, history, turn, last, running, aiDepth = 3;

  // AI ê³µê²© ìš°ì„ ë„ ì„¤ì • (1.0ë³´ë‹¤ ë†’ìœ¼ë©´ ê³µê²© ìš°ì„ , ë” ë†’ê²Œ ì„¤ì •)
  const OFFENSE_PRIORITY_FACTOR = 1.5;

  // AIê°€ ê³ ë ¤í•˜ëŠ” ì„ì‹œ í›„ë³´ ëŒë“¤ì„ ì €ì¥í•  ë°°ì—´
  let tempCandidates = [];

  const init = () => {
    board = Array.from({length: size}, () => Array(size).fill(0));
    history = [];
    last = null;
    tempCandidates = []; // ì´ˆê¸°í™” ì‹œ ì„ì‹œ í›„ë³´ë„ ì´ˆê¸°í™”
  };

  const render = () => {
    ctx.clearRect(0,0,c.width,c.height);
    drawBoard();
    drawStones();
    drawTempCandidates(); // ì„ì‹œ í›„ë³´ ëŒ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
  };

  const drawBoard = () => {
    ctx.strokeStyle = '#444'; ctx.lineWidth = 1;
    for (let i = 0; i < size; i++) {
      ctx.beginPath(); ctx.moveTo(offset, offset + i * cell); ctx.lineTo(offset + (size - 1) * cell, offset + i * cell); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(offset + i * cell, offset); ctx.lineTo(offset + i * cell, offset + (size - 1) * cell); ctx.stroke();
    }
    [[7,7],[3,3],[3,11],[11,3],[11,11]].forEach(([x,y]) => {
      ctx.beginPath(); ctx.arc(offset+x*cell, offset+y*cell, 5, 0, 2*Math.PI); ctx.fillStyle="#555"; ctx.fill();
    });
  };

  const drawStones = () => {
    for (let y = 0; y < size; y++) for (let x = 0; x < size; x++) if (board[y][x]) {
      ctx.beginPath();
      ctx.arc(offset + x * cell, offset + y * cell, cell / 2.8, 0, 2 * Math.PI);
      ctx.fillStyle = board[y][x] === 1 ? "#000" : "#eee";
      ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 3;
      ctx.fill(); ctx.shadowBlur = 0; ctx.strokeStyle = "#333"; ctx.stroke();
    }
    if (last) {
      ctx.strokeStyle = "#0d6efd"; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(offset + last.x * cell, offset + last.y * cell, cell / 2.8 + 3, 0, 2 * Math.PI); ctx.stroke();
    }
  };

  // AIê°€ ê³ ë ¤í•˜ëŠ” ì„ì‹œ í›„ë³´ ëŒì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
  const drawTempCandidates = () => {
    for (const candidate of tempCandidates) {
      ctx.beginPath();
      ctx.arc(offset + candidate.x * cell, offset + candidate.y * cell, cell / 2.8, 0, 2 * Math.PI);
      ctx.fillStyle = candidate.color;
      ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 3;
      ctx.fill(); ctx.shadowBlur = 0;
      ctx.strokeStyle = "#333"; ctx.stroke();

      // ì ìˆ˜ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
      ctx.fillStyle = "#000"; // í…ìŠ¤íŠ¸ ìƒ‰ìƒ (ê²€ì •)
      ctx.font = "bold 12px sans-serif"; // í°íŠ¸ ì„¤ì •
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      // ì ìˆ˜ê°€ ë„ˆë¬´ í¬ë©´ ì§€ìˆ˜ í‘œê¸°ë²•ìœ¼ë¡œ í‘œì‹œ
      const scoreText = candidate.score >= 1000000 ? (candidate.score / 1000000).toFixed(1) + 'M' : candidate.score.toFixed(0);
      ctx.fillText(scoreText, offset + candidate.x * cell, offset + candidate.y * cell);
    }
  };

  const checkWin = (x, y, t) => {
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];
    for (let [dx,dy] of dirs) {
      let cnt = 1;
      for (let d of [-1,1]) {
        let nx = x + dx * d, ny = y + dy * d;
        while (board[ny]?.[nx] === t) { cnt++; nx += dx * d; ny += dy * d; }
      }
      if (cnt >= 5) return true;
    }
    return false;
  };

  const nearby = (x,y) => {
    for (let dy = -2; dy <= 2; dy++)
      for (let dx = -2; dx <= 2; dx++) {
        let nx = x + dx, ny = y + dy;
        if (nx >= 0 && ny >= 0 && nx < size && ny < size && board[ny][nx]) return true;
      }
    return false;
  };

  const moves = () => {
    const arr = [];
    for (let y = 0; y < size; y++)
      for (let x = 0; x < size; x++)
        if (!board[y][x] && nearby(x,y)) arr.push([x,y]);
    return arr.length ? arr : [[7,7]]; // ì£¼ë³€ì— ë‘˜ ê³³ ì—†ìœ¼ë©´ ì¤‘ì•™ìœ¼ë¡œ
  };

  // evalBoard í•¨ìˆ˜ë¥¼ ë” ê¼¼ê¼¼í•˜ê³  ê·¹ë‹¨ì ìœ¼ë¡œ ìˆ˜ì • (3, 4 ë§‰ê¸° ê°•í™”)
  const evalBoard = (b, t) => {
    let score = 0;
    const dirs = [[1,0],[0,1],[1,1],[1,-1]];

    // Helper: í•´ë‹¹ ì¢Œí‘œê°€ ë³´ë“œ ë²”ìœ„ ë‚´ì— ìˆê³  ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    const isEmpty = (x, y) => x >= 0 && x < size && y >= 0 && y < size && b[y][x] === 0;

    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        if (b[y][x] !== t) continue; // í˜„ì¬ í”Œë ˆì´ì–´ì˜ ëŒë§Œ í‰ê°€

        for (let [dx,dy] of dirs) {
          let cnt = 1; // ì—°ì†ëœ ëŒ ê°œìˆ˜
          let openEnds = 0; // ì–‘ ëì´ ì—´ë¦° ê°œìˆ˜ (0: ì–‘ìª½ ë§‰í˜, 1: í•œìª½ ì—´ë¦¼, 2: ì–‘ìª½ ì—´ë¦¼)

          // í•œ ë°©í–¥ìœ¼ë¡œ ì—°ì†ëœ ëŒ ê°œìˆ˜ ì„¸ê¸° ë° ë í™•ì¸
          let nx = x + dx, ny = y + dy;
          while (nx >= 0 && nx < size && ny >= 0 && ny < size && b[ny][nx] === t) {
            cnt++;
            nx += dx;
            ny += dy;
          }
          if (isEmpty(nx, ny)) openEnds++; // ëì´ ë¹„ì–´ìˆìœ¼ë©´ ì—´ë¦° ê²ƒìœ¼ë¡œ ê°„ì£¼

          // ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ì—°ì†ëœ ëŒ ê°œìˆ˜ ì„¸ê¸° ë° ë í™•ì¸
          nx = x - dx; ny = y - dy;
          while (nx >= 0 && nx < size && ny >= 0 && ny < size && b[ny][nx] === t) {
            cnt++;
            nx -= dx;
            ny -= dy;
          }
          if (isEmpty(nx, ny)) openEnds++; // ëì´ ë¹„ì–´ìˆìœ¼ë©´ ì—´ë¦° ê²ƒìœ¼ë¡œ ê°„ì£¼

          // ê¼¼ê¼¼í•˜ê³  ê·¹ë‹¨ì ì¸ ì ìˆ˜ ë¶€ì—¬
          if (cnt >= 5) { // 5ê°œ ì´ìƒ: ìŠ¹ë¦¬ (ê°€ì¥ ë†’ì€ ì ìˆ˜)
            score += 10000000;
          } else if (cnt === 4) {
            if (openEnds === 2) score += 5000000; // ì–‘ìª½ì´ ì—´ë¦° 4ê°œ (Live Four): ê±°ì˜ ìŠ¹ë¦¬ì™€ ë™ê¸‰
            else if (openEnds === 1) score += 100000; // í•œìª½ì´ ì—´ë¦° 4ê°œ (Blocked Four)
          } else if (cnt === 3) {
            if (openEnds === 2) score += 50000; // ì–‘ìª½ì´ ì—´ë¦° 3ê°œ (Live Three): ê°•ë ¥í•œ ìœ„í˜‘
            else if (openEnds === 1) score += 5000; // í•œìª½ì´ ì—´ë¦° 3ê°œ (Blocked Three)
          } else if (cnt === 2) {
            if (openEnds === 2) score += 500; // ì–‘ìª½ì´ ì—´ë¦° 2ê°œ (Live Two)
            else if (openEnds === 1) score += 50; // í•œìª½ì´ ì—´ë¦° 2ê°œ (Blocked Two)
          }
        }
      }
    }
    return score;
  };

  const minimax = (b,d,a,beta,t,maxim) => {
    // íƒìƒ‰ ê¹Šì´ì— ë„ë‹¬í•˜ë©´ ë³´ë“œ í‰ê°€
    if (d <= 0) {
      // AIì˜ ê³µê²© ì ìˆ˜ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ê³µê²© ìš°ì„  ì „ëµ ë°˜ì˜
      // ìƒëŒ€ë°©(í”Œë ˆì´ì–´)ì˜ 3, 4ì— ëŒ€í•œ í˜ë„í‹°ë¥¼ ë” ê°•ë ¥í•˜ê²Œ ì ìš©
      return evalBoard(b,2) * OFFENSE_PRIORITY_FACTOR - evalBoard(b,1) * 2; // í”Œë ˆì´ì–´ ì ìˆ˜ì— 2ë°° í˜ë„í‹°
    }

    let ms = moves(); // ê°€ëŠ¥í•œ ëª¨ë“  ìˆ˜
    if (!ms.length) return 0; // ë” ì´ìƒ ë‘˜ ê³³ì´ ì—†ìœ¼ë©´ 0ì 

    // --- ìˆ˜ ìˆœì„œ ì •ë ¬ (Move Ordering) ---
    const scoredMoves = [];
    for (let [x, y] of ms) {
      b[y][x] = t; // ì„ì‹œë¡œ ìˆ˜ë¥¼ ë‘ 
      // í•´ë‹¹ ìˆ˜ë¥¼ ë’€ì„ ë•Œì˜ ë³´ë“œ í‰ê°€ ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      // í˜„ì¬ í”Œë ˆì´ì–´(t)ì˜ ì ìˆ˜ì—ì„œ ìƒëŒ€ë°©(3-t)ì˜ ì ìˆ˜ë¥¼ ëº€ ê°’ìœ¼ë¡œ ì •ë ¬
      let heuristicScore = evalBoard(b, t) - evalBoard(b, 3 - t);
      b[y][x] = 0; // ìˆ˜ë¥¼ ë‹¤ì‹œ ëºŒ (ë°±íŠ¸ë˜í‚¹)
      scoredMoves.push({ x, y, score: heuristicScore });
    }

    // ì ìˆ˜ê°€ ë†’ì€ ìˆ˜ë¶€í„° ë¨¼ì € íƒìƒ‰í•˜ë„ë¡ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    scoredMoves.sort((m1, m2) => m2.score - m1.score);
    ms = scoredMoves.map(m => [m.x, m.y]); // ì •ë ¬ëœ ìˆ˜ ëª©ë¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸

    let best = maxim ? -Infinity : Infinity;

    // ì •ë ¬ëœ ìˆ˜ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ íƒìƒ‰ ì‹œì‘
    for (let [x,y] of ms) {
      b[y][x] = t; // ìˆ˜ë¥¼ ë‘ 
      let sc;
      // í˜„ì¬ ìˆ˜ê°€ ìŠ¹ë¦¬ ìˆ˜ì¸ì§€ í™•ì¸ (íƒìƒ‰ ê¹Šì´ì™€ ê´€ê³„ì—†ì´ ì¦‰ì‹œ ìŠ¹ë¦¬ íŒë‹¨)
      if (checkWin(x,y,t)) {
        sc = (t === 2) ? 100000000 : -100000000; // AI ìŠ¹ë¦¬ ì‹œ ë§¤ìš° ë†’ì€ ì ìˆ˜, ìƒëŒ€ ìŠ¹ë¦¬ ì‹œ ë§¤ìš° ë‚®ì€ ì ìˆ˜
      } else {
        // ë‹¤ìŒ í„´ìœ¼ë¡œ ë„˜ì–´ê°€ minimax ì¬ê·€ í˜¸ì¶œ
        sc = minimax(b, d - 1, a, beta, 3 - t, !maxim);
      }
      b[y][x] = 0; // ìˆ˜ë¥¼ ë‹¤ì‹œ ëºŒ (ë°±íŠ¸ë˜í‚¹)

      if (maxim) { // ìµœëŒ€í™” í”Œë ˆì´ì–´ (AI)
        best = Math.max(best, sc);
        a = Math.max(a, sc);
      } else { // ìµœì†Œí™” í”Œë ˆì´ì–´ (ì¸ê°„)
        best = Math.min(best, sc);
        beta = Math.min(beta, sc);
      }
      if (beta <= a) break; // ì•ŒíŒŒ-ë² íƒ€ ê°€ì§€ì¹˜ê¸°
    }
    return best;
  };

  // aiMove í•¨ìˆ˜ê°€ Promiseë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •í•˜ì—¬ ë¹„ë™ê¸° ì²˜ë¦¬
  const aiMove = () => {
    const ms = moves(); // ê°€ëŠ¥í•œ ëª¨ë“  ìˆ˜

    // AI í„´ ì‹œì‘ ì‹œ ì„ì‹œ í›„ë³´ ëŒ ì´ˆê¸°í™”
    tempCandidates = [];

    // 1. AIì˜ ì¦‰ê°ì ì¸ ìŠ¹ë¦¬ í™•ì¸ (ê³µê²© ë¨¼ì €)
    for (let [x, y] of ms) {
      board[y][x] = 2; // AI ëŒì„ ì„ì‹œë¡œ ë†“ì•„ë´„
      if (checkWin(x, y, 2)) {
        board[y][x] = 0; // ëŒì„ ë‹¤ì‹œ ëºŒ
        logMsg(`AI ë¶„ì„: (${x+1},${y+1})ì— ë‘ë©´ AI ìŠ¹ë¦¬!`);
        return Promise.resolve([x, y]); // ì¦‰ì‹œ ìŠ¹ë¦¬ ì‹œ Promiseë¡œ ë°˜í™˜
      }
      board[y][x] = 0; // ëŒì„ ë‹¤ì‹œ ëºŒ
    }

    // 2. í”Œë ˆì´ì–´ì˜ ì¦‰ê°ì ì¸ ìŠ¹ë¦¬ í™•ì¸ (ìˆ˜ë¹„ ë‚˜ì¤‘ - ë§‰ì„ ê³³ ìˆìœ¼ë©´ ë§‰ê³ )
    for (let [x, y] of ms) {
      board[y][x] = 1; // í”Œë ˆì´ì–´ ëŒì„ ì„ì‹œë¡œ ë†“ì•„ë´„
      if (checkWin(x, y, 1)) {
        board[y][x] = 0; // ëŒì„ ë‹¤ì‹œ ëºŒ
        logMsg(`AI ë¶„ì„: (${x+1},${y+1})ì— ë‘ë©´ í”Œë ˆì´ì–´ ìŠ¹ë¦¬! ë§‰ì•„ì•¼ í•¨!`);
        return Promise.resolve([x, y]); // ì¦‰ì‹œ ë°©ì–´ ì‹œ Promiseë¡œ ë°˜í™˜
      }
      board[y][x] = 0; // ëŒì„ ë‹¤ì‹œ ëºŒ
    }

    // 3. ì¦‰ê°ì ì¸ ìŠ¹ë¦¬ë‚˜ ë°©ì–´í•  ê³³ì´ ì—†ë‹¤ë©´, ê¸°ì¡´ì²˜ëŸ¼ minimaxë¡œ ìµœì ì˜ ì „ëµì ì¸ ìˆ˜ íƒìƒ‰
    const candidates = [];
    let bestScore = -Infinity;

    for (let [x, y] of ms) {
      board[y][x] = 2; // AI ëŒì„ ì„ì‹œë¡œ ë†“ì•„ë´„
      // minimaxë¥¼ í†µí•´ í•´ë‹¹ ìˆ˜ ì´í›„ì˜ ìµœì  ì ìˆ˜ ê³„ì‚°
      let score = minimax(board, aiDepth, -Infinity, Infinity, 1, false); // ë‹¤ìŒ í„´ì€ ì¸ê°„(1), ìµœì†Œí™” í”Œë ˆì´ì–´
      board[y][x] = 0; // ëŒì„ ë‹¤ì‹œ ëºŒ

      candidates.push({ x, y, score });
      if (score > bestScore) {
        bestScore = score;
      }
    }

    // í›„ë³´ ìˆ˜ë“¤ì„ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë¡œê·¸ ë° ì‹œê°í™” ì¶œë ¥ì„ ìœ„í•´)
    candidates.sort((a, b) => b.score - a.score);

    // ìƒìœ„ Nê°œ í›„ë³´ë¥¼ tempCandidatesì— ì €ì¥í•˜ì—¬ í™”ë©´ì— í‘œì‹œ
    const numCandidatesToShow = Math.min(candidates.length, 5); // ìƒìœ„ 5ê°œ í›„ë³´ í‘œì‹œ
    tempCandidates = candidates.slice(0, numCandidatesToShow).map(c => ({
      x: c.x,
      y: c.y,
      score: c.score, // ì ìˆ˜ë„ í•¨ê»˜ ì €ì¥
      color: "rgba(100, 100, 255, 0.5)" // ë°˜íˆ¬ëª…í•œ í•˜ëŠ˜ìƒ‰
    }));
    render(); // ì„ì‹œ í›„ë³´ ëŒë“¤ê³¼ ì ìˆ˜ë“¤ì„ í™”ë©´ì— ê·¸ë¦¼

    // ë¡œê·¸ì— ìƒìœ„ í›„ë³´ ìˆ˜ì™€ ì ìˆ˜ ì¶œë ¥
    logMsg("--- AI ë¶„ì„ ê²°ê³¼ (ìƒìœ„ " + numCandidatesToShow + "ê°œ í›„ë³´) ---");
    candidates.slice(0, numCandidatesToShow).forEach(c => {
      logMsg(`  (${c.x+1},${c.y+1}): ì ìˆ˜ ${c.score}`);
    });
    logMsg("---------------------------------");

    // Promiseë¥¼ ë°˜í™˜í•˜ì—¬ ì¼ì • ì‹œê°„ í›„ ì‹¤ì œ AI ìˆ˜ë¥¼ ë‘ë„ë¡ ì²˜ë¦¬
    return new Promise(resolve => {
      setTimeout(() => {
        tempCandidates = []; // ì„ì‹œ í›„ë³´ ëŒ ì§€ìš°ê¸°
        const bestMoves = candidates.filter(m => m.score === bestScore);
        const pick = bestMoves[Math.floor(Math.random() * bestMoves.length)];
        resolve([pick.x, pick.y]); // ìµœì¢… ì„ íƒëœ ìˆ˜ë¥¼ Promiseë¡œ ë°˜í™˜
      }, 1000); // 1.5ì´ˆ ë™ì•ˆ í›„ë³´ ëŒë“¤ì„ ë³´ì—¬ì¤Œ (ì ìˆ˜ í™•ì¸ ì‹œê°„ í™•ë³´)
    });
  };

  const logMsg = m => { log.textContent += m + "\n"; log.scrollTop = log.scrollHeight; };

  $("startBtn").onclick = () => {
    init(); render(); log.textContent = "";
    running = true; turn = +$("firstTurn").value;
    // ë‚œì´ë„ì— ë”°ë¥¸ AI íƒìƒ‰ ê¹Šì´ ì„¤ì • (ìµœê³  ë‚œì´ë„ì—ì„œ ê¹Šì´ ì¦ê°€)
    aiDepth = { "1": 1, "2": 2, "3": 3, "4": 4, "5": 6, "6": 7 }[$("difficulty").value]; // 'ê³ ìˆ˜' 6, 'ì‹ ì˜ í•œ ìˆ˜' 7ë¡œ ì¦ê°€
    history = [JSON.stringify(board)];
    $("undoBtn").disabled = false;
    $("restartBtn").disabled = false;
    $("forfeitBtn").disabled = false;
    if (turn === 2) { // AI ì„ ê³µ
      board[7][7] = 2; last = {x:7,y:7}; render(); turn = 1; logMsg("AI ì°©ìˆ˜: (8,8)");
      history.push(JSON.stringify(board));
    } else logMsg("í”Œë ˆì´ì–´ ì„ ê³µ");
  };

  $("board").onclick = e => {
    if (!running || turn !== 1) return; // ê²Œì„ ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜ AI í„´ì´ë©´ ë¬´ì‹œ
    const r = c.getBoundingClientRect();
    const x = Math.round((e.clientX - r.left) * c.width / r.width - offset) / cell;
    const y = Math.round((e.clientY - r.top) * c.height / r.height - offset) / cell;
    const xi = Math.round(x), yi = Math.round(y);
    if (xi < 0 || yi < 0 || xi >= size || yi >= size || board[yi][xi]) return; // ìœ íš¨í•˜ì§€ ì•Šì€ ìœ„ì¹˜ê±°ë‚˜ ì´ë¯¸ ëŒì´ ìˆìœ¼ë©´ ë¬´ì‹œ

    board[yi][xi] = 1; last = {x:xi,y:yi}; render(); history.push(JSON.stringify(board));
    if (checkWin(xi, yi, 1)) { alert("í”Œë ˆì´ì–´ ìŠ¹ë¦¬!"); running = false; return; } // í”Œë ˆì´ì–´ ìŠ¹ë¦¬ í™•ì¸
    turn = 2; logMsg(`í”Œë ˆì´ì–´: (${xi+1},${yi+1})`);

    // AI í„´ ì§€ì—° ì²˜ë¦¬ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
    // ì‚¬ìš©ì í„´ ì¢…ë£Œ í›„ ë°”ë¡œ AI ê³„ì‚° ì‹œì‘ ë° ì‹œê°í™”
    setTimeout(() => {
      if (!running) return;
      // aiMoveê°€ Promiseë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ .then()ìœ¼ë¡œ ê²°ê³¼ ì²˜ë¦¬
      aiMove().then(([x, y]) => {
        board[y][x] = 2; last = {x,y}; render(); history.push(JSON.stringify(board));
        logMsg(`AI: (${x+1},${y+1})`);
        if (checkWin(x, y, 2)) { alert("AI ìŠ¹ë¦¬!"); running = false; }
        turn = 1; // í„´ ë‹¤ì‹œ í”Œë ˆì´ì–´ë¡œ
      });
    }, 30); // 30ms ì§€ì—°
  };

  $("undoBtn").onclick = () => {
    if (!running || history.length < 2) return;
    history.pop(); // í˜„ì¬ ìƒíƒœ ì œê±°
    board = JSON.parse(history[history.length - 1]); // ì´ì „ ìƒíƒœë¡œ ë³µì›
    render();
    turn = 3 - turn; // í„´ ë˜ëŒë¦¬ê¸°
    logMsg("ë¬´ë¥´ê¸° ì‹¤í–‰");
  };

  $("restartBtn").onclick = () => {
    $("startBtn").click(); // ì‹œì‘ ë²„íŠ¼ í´ë¦­ íš¨ê³¼
  };

  $("forfeitBtn").onclick = () => {
    if (!running) return;
    running = false;
    logMsg(turn === 1 ? "í”Œë ˆì´ì–´ê°€ í¬ê¸°í–ˆìŠµë‹ˆë‹¤." : "AIê°€ í¬ê¸°í–ˆìŠµë‹ˆë‹¤.");
    alert("ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  };

  init(); render();
})();

</script>
</body>
</html>
